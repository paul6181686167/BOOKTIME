#!/usr/bin/env python3
"""
Test des am√©liorations du modal auteur - Session 87.8
Validation des nouveaux endpoints pour afficher toutes les ≈ìuvres d'un auteur
"""

import requests
import json
import time
from datetime import datetime

# Configuration
BASE_URL = "http://localhost:8001"
TEST_AUTHORS = [
    "J.K. Rowling",
    "Stephen King", 
    "Agatha Christie",
    "George R.R. Martin",
    "J.R.R. Tolkien"
]

def test_author_works_endpoints():
    """Test des nouveaux endpoints pour les ≈ìuvres des auteurs"""
    print("üéØ TEST DES NOUVEAUX ENDPOINTS ≈íUVRES AUTEURS")
    print("=" * 60)
    
    results = {
        "wikipedia_works": {},
        "openlibrary_works": {},
        "summary": {
            "total_tests": 0,
            "successful_tests": 0,
            "failed_tests": 0
        }
    }
    
    for author in TEST_AUTHORS:
        print(f"\nüìö Test pour l'auteur: {author}")
        print("-" * 40)
        
        # Test 1: Endpoint Wikipedia Works
        print(f"üîç Test Wikipedia works endpoint...")
        wikipedia_url = f"{BASE_URL}/api/wikipedia/author/{author}/works"
        
        try:
            response = requests.get(wikipedia_url, timeout=15)
            results["summary"]["total_tests"] += 1
            
            if response.status_code == 200:
                data = response.json()
                if data.get("found"):
                    works = data.get("works", {})
                    series_count = len(works.get("series", []))
                    individual_count = len(works.get("individual_books", []))
                    total_books = works.get("total_books", 0)
                    sources = works.get("sources", {})
                    
                    print(f"‚úÖ Wikipedia works: {total_books} livres trouv√©s")
                    print(f"   üìñ S√©ries: {series_count}")
                    print(f"   üìö Livres individuels: {individual_count}")
                    print(f"   üîó Sources: {sources}")
                    
                    results["wikipedia_works"][author] = {
                        "success": True,
                        "total_books": total_books,
                        "series_count": series_count,
                        "individual_count": individual_count,
                        "sources": sources
                    }
                    results["summary"]["successful_tests"] += 1
                else:
                    print(f"‚ö†Ô∏è Wikipedia works: Auteur non trouv√©")
                    results["wikipedia_works"][author] = {"success": False, "reason": "Not found"}
                    results["summary"]["failed_tests"] += 1
            else:
                print(f"‚ùå Wikipedia works: Erreur HTTP {response.status_code}")
                results["wikipedia_works"][author] = {"success": False, "reason": f"HTTP {response.status_code}"}
                results["summary"]["failed_tests"] += 1
                
        except Exception as e:
            print(f"‚ùå Wikipedia works: Erreur - {str(e)}")
            results["wikipedia_works"][author] = {"success": False, "reason": str(e)}
            results["summary"]["failed_tests"] += 1
        
        # Test 2: Endpoint OpenLibrary Works (n√©cessite authentification)
        print(f"üîç Test OpenLibrary works endpoint...")
        openlibrary_url = f"{BASE_URL}/api/openlibrary/author/{author}/works"
        
        # Cr√©er un token test simple (pr√©nom/nom)
        auth_data = {"first_name": "Test", "last_name": "User"}
        try:
            auth_response = requests.post(f"{BASE_URL}/api/auth/login", json=auth_data, timeout=10)
            if auth_response.status_code == 200:
                token = auth_response.json().get("access_token")
                headers = {"Authorization": f"Bearer {token}"}
                
                results["summary"]["total_tests"] += 1
                ol_response = requests.get(openlibrary_url, headers=headers, timeout=15)
                
                if ol_response.status_code == 200:
                    ol_data = ol_response.json()
                    if ol_data.get("found"):
                        total_books = ol_data.get("total_books", 0)
                        series_count = len(ol_data.get("series", []))
                        individual_count = len(ol_data.get("individual_books", []))
                        sources = ol_data.get("sources", {})
                        
                        print(f"‚úÖ OpenLibrary works: {total_books} livres trouv√©s")
                        print(f"   üìñ S√©ries: {series_count}")
                        print(f"   üìö Livres individuels: {individual_count}")
                        print(f"   üîó Sources: {sources}")
                        
                        results["openlibrary_works"][author] = {
                            "success": True,
                            "total_books": total_books,
                            "series_count": series_count,
                            "individual_count": individual_count,
                            "sources": sources
                        }
                        results["summary"]["successful_tests"] += 1
                    else:
                        print(f"‚ö†Ô∏è OpenLibrary works: Auteur non trouv√©")
                        results["openlibrary_works"][author] = {"success": False, "reason": "Not found"}
                        results["summary"]["failed_tests"] += 1
                else:
                    print(f"‚ùå OpenLibrary works: Erreur HTTP {ol_response.status_code}")
                    results["openlibrary_works"][author] = {"success": False, "reason": f"HTTP {ol_response.status_code}"}
                    results["summary"]["failed_tests"] += 1
            else:
                print(f"‚ùå OpenLibrary works: Erreur authentification")
                results["openlibrary_works"][author] = {"success": False, "reason": "Auth failed"}
                results["summary"]["failed_tests"] += 1
                
        except Exception as e:
            print(f"‚ùå OpenLibrary works: Erreur - {str(e)}")
            results["openlibrary_works"][author] = {"success": False, "reason": str(e)}
            results["summary"]["failed_tests"] += 1
    
    return results

def test_endpoint_performance():
    """Test des performances des nouveaux endpoints"""
    print("\n‚ö° TEST DES PERFORMANCES")
    print("=" * 60)
    
    performance_results = {}
    
    for author in TEST_AUTHORS[:3]:  # Test seulement 3 auteurs pour la performance
        print(f"\nüìä Test performance pour: {author}")
        
        # Test Wikipedia works
        start_time = time.time()
        try:
            response = requests.get(f"{BASE_URL}/api/wikipedia/author/{author}/works", timeout=10)
            end_time = time.time()
            
            if response.status_code == 200:
                duration = end_time - start_time
                data = response.json()
                total_books = data.get("works", {}).get("total_books", 0)
                
                print(f"‚úÖ Wikipedia: {duration:.2f}s pour {total_books} livres")
                performance_results[f"{author}_wikipedia"] = {
                    "duration": duration,
                    "books": total_books,
                    "success": True
                }
            else:
                print(f"‚ùå Wikipedia: Erreur HTTP {response.status_code}")
                performance_results[f"{author}_wikipedia"] = {"success": False}
                
        except Exception as e:
            print(f"‚ùå Wikipedia: Timeout ou erreur - {str(e)}")
            performance_results[f"{author}_wikipedia"] = {"success": False, "error": str(e)}
    
    return performance_results

def test_data_structure():
    """Test de la structure des donn√©es retourn√©es"""
    print("\nüèóÔ∏è TEST DE LA STRUCTURE DES DONN√âES")
    print("=" * 60)
    
    # Test avec J.K. Rowling pour analyser la structure
    author = "J.K. Rowling"
    print(f"üìã Analyse structure pour: {author}")
    
    try:
        response = requests.get(f"{BASE_URL}/api/wikipedia/author/{author}/works", timeout=10)
        if response.status_code == 200:
            data = response.json()
            
            print(f"üîç Structure r√©ponse Wikipedia works:")
            print(f"   - found: {data.get('found')}")
            print(f"   - author: {data.get('author')}")
            
            if data.get("found"):
                works = data.get("works", {})
                print(f"   - works.total_books: {works.get('total_books')}")
                print(f"   - works.series: {len(works.get('series', []))} s√©ries")
                print(f"   - works.individual_books: {len(works.get('individual_books', []))} livres")
                print(f"   - works.sources: {works.get('sources')}")
                
                # Analyser une s√©rie si disponible
                series = works.get("series", [])
                if series:
                    first_series = series[0]
                    print(f"   - Premi√®re s√©rie: {first_series.get('name')}")
                    print(f"     - books: {len(first_series.get('books', []))}")
                    print(f"     - source: {first_series.get('source')}")
                
                # Analyser un livre individuel si disponible
                individual_books = works.get("individual_books", [])
                if individual_books:
                    first_book = individual_books[0]
                    print(f"   - Premier livre: {first_book.get('title')}")
                    print(f"     - year: {first_book.get('year')}")
                    print(f"     - source: {first_book.get('source')}")
                
                return True
        
        print(f"‚ùå Erreur lors de l'analyse de structure")
        return False
        
    except Exception as e:
        print(f"‚ùå Erreur: {str(e)}")
        return False

def generate_report(results, performance_results):
    """G√©n√©ration du rapport final"""
    print("\nüìä RAPPORT FINAL - AM√âLIORATIONS MODAL AUTEUR")
    print("=" * 60)
    
    summary = results["summary"]
    success_rate = (summary["successful_tests"] / summary["total_tests"]) * 100 if summary["total_tests"] > 0 else 0
    
    print(f"‚úÖ Tests r√©ussis: {summary['successful_tests']}/{summary['total_tests']} ({success_rate:.1f}%)")
    print(f"‚ùå Tests √©chou√©s: {summary['failed_tests']}")
    
    print(f"\nüìö R√âSULTATS PAR AUTEUR:")
    for author in TEST_AUTHORS:
        print(f"\nüë§ {author}:")
        
        # Wikipedia results
        wiki_result = results["wikipedia_works"].get(author, {})
        if wiki_result.get("success"):
            print(f"   üìñ Wikipedia: {wiki_result['total_books']} livres ({wiki_result['series_count']} s√©ries)")
        else:
            print(f"   üìñ Wikipedia: ‚ùå {wiki_result.get('reason', 'Erreur inconnue')}")
        
        # OpenLibrary results  
        ol_result = results["openlibrary_works"].get(author, {})
        if ol_result.get("success"):
            print(f"   üìö OpenLibrary: {ol_result['total_books']} livres ({ol_result['series_count']} s√©ries)")
        else:
            print(f"   üìö OpenLibrary: ‚ùå {ol_result.get('reason', 'Erreur inconnue')}")
    
    print(f"\n‚ö° PERFORMANCES:")
    for key, perf in performance_results.items():
        if perf.get("success"):
            print(f"   {key}: {perf['duration']:.2f}s pour {perf['books']} livres")
    
    print(f"\nüéØ CONCLUSION:")
    if success_rate >= 80:
        print("‚úÖ Les am√©liorations du modal auteur fonctionnent correctement")
        print("‚úÖ Les nouveaux endpoints r√©cup√®rent toutes les ≈ìuvres des auteurs")
        print("‚úÖ La structure des donn√©es est conforme aux attentes")
    else:
        print("‚ö†Ô∏è Certains endpoints pr√©sentent des probl√®mes")
        print("‚ö†Ô∏è V√©rifications suppl√©mentaires n√©cessaires")
    
    # Sauvegarder les r√©sultats
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"author_modal_test_results_{timestamp}.json"
    
    full_results = {
        "timestamp": timestamp,
        "summary": summary,
        "results": results,
        "performance": performance_results
    }
    
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(full_results, f, indent=2, ensure_ascii=False)
    
    print(f"\nüíæ R√©sultats sauvegard√©s dans: {filename}")

def main():
    """Fonction principale"""
    print("üöÄ D√âBUT DES TESTS - AM√âLIORATIONS MODAL AUTEUR")
    print("=" * 60)
    print(f"üïê D√©but: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"üîó Backend: {BASE_URL}")
    
    # V√©rifier que le backend est accessible
    try:
        health_response = requests.get(f"{BASE_URL}/health", timeout=5)
        if health_response.status_code == 200:
            print("‚úÖ Backend accessible")
        else:
            print(f"‚ùå Backend inaccessible: {health_response.status_code}")
            return
    except Exception as e:
        print(f"‚ùå Backend inaccessible: {str(e)}")
        return
    
    # Ex√©cuter les tests
    results = test_author_works_endpoints()
    performance_results = test_endpoint_performance()
    structure_ok = test_data_structure()
    
    # G√©n√©rer le rapport
    generate_report(results, performance_results)
    
    print(f"\nüèÅ FIN DES TESTS")
    print(f"üïê Fin: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

if __name__ == "__main__":
    main()